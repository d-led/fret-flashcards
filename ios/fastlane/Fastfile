# Fastfile for String Homework Tutor
# This file contains the fastlane.tools configuration

default_platform(:ios)

platform :ios do
  desc "Generate screenshots for App Store"
  lane :screenshots do
    snapshot
  end

  desc "Test authentication with App Store Connect"
  lane :test_auth do
    # # Clear any API key environment variables to force username/password auth
    # ENV.delete("APP_STORE_CONNECT_API_KEY_PATH")
    # ENV.delete("APP_STORE_CONNECT_API_KEY_ID")
    # ENV.delete("APP_STORE_CONNECT_API_ISSUER_ID")
    
    # Test authentication by connecting to App Store Connect
    require 'spaceship'
    
    UI.message("Testing authentication...")
    Spaceship::ConnectAPI.login(ENV["APPLE_ID"])
    UI.success("✅ Authentication successful!")
    UI.message("Using Apple ID: #{ENV["APPLE_ID"]}")
    UI.message("Using application-specific password: #{ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] ? '✅ Set' : '❌ Not set'}")
    
    # Test app access
    app = Spaceship::ConnectAPI::App.find("com.dled.stringhomeworktutor")
    UI.success("✅ App access confirmed: #{app.name}")
    
  rescue => ex
    UI.error("Authentication failed: #{ex.message}")
    raise ex
  end

  desc "Build and upload to App Store Connect"
  lane :release do
    # Build the app
    build_app(
      scheme: "App",
      workspace: "./App/App.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_team_id: ENV["APPLE_TEAM_ID"],
      xcargs: "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          "com.dled.stringhomeworktutor" => ENV["PROVISIONING_PROFILE_UUID"]
        }
      }
    )
    
    # Upload to App Store Connect
    upload_to_app_store(
      username: ENV["APPLE_ID"],
      force: true,
      skip_binary_upload: false,
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true
    )
  end

  desc "Upload metadata only to App Store Connect"
  lane :upload_metadata do
    upload_to_app_store(
      username: ENV["APPLE_ID"],
      app_identifier: "com.dled.stringhomeworktutor",
      force: true,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      skip_app_version_update: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false
    )
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    # # Clear any API key environment variables to force username/password auth
    # ENV.delete("APP_STORE_CONNECT_API_KEY_PATH")
    # ENV.delete("APP_STORE_CONNECT_API_KEY_ID")
    # ENV.delete("APP_STORE_CONNECT_API_ISSUER_ID")
    
    deliver(
      username: ENV["APPLE_ID"],
      app_identifier: "com.dled.stringhomeworktutor",
      force: true,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      skip_app_version_update: true,
      automatic_release: false,
      overwrite_screenshots: true,
      api_key_path: nil,
      api_key: nil
    )
  end

  desc "Upload screenshots without replacing existing ones"
  lane :upload_screenshots_add do
    # # Clear any API key environment variables to force username/password auth
    # ENV.delete("APP_STORE_CONNECT_API_KEY_PATH")
    # ENV.delete("APP_STORE_CONNECT_API_KEY_ID")
    # ENV.delete("APP_STORE_CONNECT_API_ISSUER_ID")
    
    deliver(
      username: ENV["APPLE_ID"],
      app_identifier: "com.dled.stringhomeworktutor",
      force: true,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      skip_app_version_update: true,
      automatic_release: false,
      overwrite_screenshots: false,
      api_key_path: nil,
      api_key: nil,
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false
    )
  end

  desc "Build for TestFlight"
  lane :build_testflight do
    # Clear any API key environment variables to force username/password auth
    # ENV.delete("APP_STORE_CONNECT_API_KEY_PATH")
    # ENV.delete("APP_STORE_CONNECT_API_KEY_ID")
    # ENV.delete("APP_STORE_CONNECT_API_ISSUER_ID")
    
    build_app(
      scheme: "App", 
      workspace: "./App/App.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_team_id: ENV["APPLE_TEAM_ID"],
      xcargs: "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          "com.dled.stringhomeworktutor" => ENV["PROVISIONING_PROFILE_UUID"]
        }
      }
    )
    
    upload_to_testflight(
      app_identifier: "com.dled.stringhomeworktutor",
      username: ENV["APPLE_ID"],
      skip_waiting_for_build_processing: true
    )
  end
end
