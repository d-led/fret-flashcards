# Fastfile for String Homework Tutor
# This file contains the fastlane.tools configuration

default_platform(:ios)

platform :ios do
  desc "Generate screenshots for App Store"
  lane :screenshots do
    snapshot
  end

  desc "Build and upload to App Store Connect"
  lane :release do
    # Build the app
    build_app(
      scheme: "App",
      workspace: "App/App.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          "com.dled.stringhomeworktutor" => ENV["PROVISIONING_PROFILE_UUID"]
        }
      }
    )
    
    # Upload to App Store Connect
    upload_to_app_store(
      username: ENV["APPLE_ID"],
      force: true,
      skip_binary_upload: false,
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true
    )
  end

  desc "Upload metadata only to App Store Connect"
  lane :upload_metadata do
    upload_to_app_store(
      username: ENV["APPLE_ID"],
      force: true,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      skip_app_version_update: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false
    )
  end

  desc "Build for TestFlight"
  lane :testflight do
    build_app(
      scheme: "App", 
      workspace: "App/App.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          "com.dled.stringhomeworktutor" => ENV["PROVISIONING_PROFILE_UUID"]
        }
      }
    )
    
    upload_to_testflight(
      username: ENV["APPLE_ID"],
      app_identifier: "com.dled.stringhomeworktutor",
      skip_waiting_for_build_processing: true
    )
  end
end
